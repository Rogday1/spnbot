# Spin Bot v2.0

Телеграм-бот с мини-приложением для игры "Колесо Фортуны".

## Структура проекта

```
├── src/                    # Исходный код
│   ├── bot/                # Код бота
│   │   ├── handlers/       # Обработчики событий бота
│   │   ├── keyboards/      # Клавиатуры
│   │   ├── middlewares/    # Middleware для бота
│   │   └── utils/          # Утилиты для бота
│   ├── webapp/             # Веб-приложение
│   │   ├── routers/        # Маршруты API
│   │   ├── middlewares/    # Middleware для веб-приложения
│   │   ├── templates/      # Шаблоны HTML
│   │   └── static/         # Статические файлы
│   ├── database/           # Работа с базой данных
│   │   ├── models/         # Модели данных
│   │   └── repositories/   # Репозитории для работы с данными
│   ├── utils/              # Общие утилиты
│   │   ├── cache.py        # Система кэширования
│   │   └── helpers.py      # Вспомогательные функции
│   └── config/             # Конфигурация
├── .env                    # Переменные окружения (не включать в Git)
├── .env.example            # Пример файла с переменными окружения
├── pyproject.toml          # Зависимости и конфигурация проекта
└── main.py                 # Точка входа в приложение
```

## Особенности проекта

- **Безопасность**: 
  - Валидация Telegram WebApp данных на клиенте и сервере
  - Защита от CSRF, XSS и инъекций
  - Ограничение частоты запросов (Rate Limiting)
  - CORS настройки с белым списком доменов
  - Проверка источников запросов (TrustedHost)

- **Производительность**:
  - Кэширование частых запросов
  - Индексы для ускорения работы с БД
  - Пул соединений с БД
  - Сжатие HTTP-ответов (Gzip)
  - Оптимизированные SQL-запросы

- **Игровая механика**:
  - Колесо Фортуны с разными секторами
  - Система бесплатных билетов
  - Таблица лидеров и рейтинг
  - Система никнеймов
  - Реферальная программа
  - Проверка подписки на обязательные каналы

## Быстрый старт

### Установка и настройка

1. Клонировать репозиторий
```bash
git clone https://github.com/username/spin-bot.git
cd spin-bot
```

2. Создать виртуальное окружение и установить зависимости
```bash
python -m venv .venv
source .venv/bin/activate  # На Windows: .venv\Scripts\activate
pip install -e .
```

3. Скопировать `.env.example` в `.env` и заполнить необходимые переменные
```bash
cp .env.example .env
# Отредактировать .env файл, добавив BOT_TOKEN и настроив другие параметры
```

### Настройка обязательных подписок

Для требования подписки на каналы перед доступом к игре, добавьте список каналов в `.env` файл:

```
REQUIRED_CHANNELS=@channel1,@channel2,t.me/channel3
```

Каждый канал может быть указан в одном из форматов:
- `@username` - Имя пользователя канала с символом @
- `username` - Имя пользователя канала без символа @
- `t.me/username` - Ссылка на канал в формате t.me
- `https://t.me/username` - Полная ссылка на канал

При запуске игры бот будет проверять подписку пользователя на все указанные каналы и предлагать подписаться, если необходимо.

### Запуск

1. **Стандартный запуск**
```bash
python main.py
```

2. **Запуск с указанием URL для WebApp** (полезно при использовании туннелирования)
```bash
python main.py --url https://your-tunnel-url.domain
```

3. **Запуск с очисткой дубликатов пользователей в БД**
```bash
python main.py --cleanup
```

## Дополнительные возможности

### Туннелирование для тестирования

Для тестирования Telegram WebApp требуется HTTPS URL. Можно использовать `pyngrok` для получения публичного URL:

```bash
python setup_webapp_url.py
```

Скрипт автоматически запустит туннель и обновит `.env` файл с полученным URL.

### Оптимизация БД (для SQLite)

```bash
python -c "import asyncio; from src.database.db import optimize_database; asyncio.run(optimize_database())"
```

## Технологии

- **Backend**:
  - aiogram 3.x - фреймворк для создания Telegram ботов
  - FastAPI - веб-фреймворк для создания API и веб-приложений
  - SQLAlchemy - ORM для работы с базой данных
  - Uvicorn - ASGI-сервер для запуска приложения

- **Frontend**:
  - Vanilla JavaScript - для клиентской логики
  - HTML/CSS - для разметки и оформления
  - Telegram Web App API - для интеграции с Telegram

## Лицензия

MIT
